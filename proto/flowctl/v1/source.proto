syntax = "proto3";

package flowctl.v1;

option go_package = "github.com/withObsrvr/flow-proto/go/gen/flowctl/v1;flowctlv1";

import "flowctl/v1/common.proto";
import "google/protobuf/empty.proto";

// SourceService defines the interface for data sources in flowctl pipelines.
// Sources produce events and stream them to processors or consumers.
service SourceService {
  // Get component information and capabilities
  rpc GetInfo(google.protobuf.Empty) returns (ComponentInfo);

  // Health check
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);

  // Stream events to downstream components
  // This is the primary method for data production
  rpc StreamEvents(StreamRequest) returns (stream Event);

  // Get current state (for resumable streaming)
  rpc GetState(StateRequest) returns (StateResponse);

  // Save state (for checkpointing)
  rpc SaveState(SaveStateRequest) returns (google.protobuf.Empty);
}

// StreamRequest initiates event streaming with optional parameters
message StreamRequest {
  // Parameters for streaming (source-specific)
  // Examples:
  //   - "start_ledger": "1000"
  //   - "end_ledger": "2000"
  //   - "filter_contract_id": "CA3D5..."
  map<string, string> params = 1;

  // Resume from saved state instead of params
  bool resume = 2;

  // Token for resuming (from previous GetState call)
  string resume_token = 3;
}

// StateRequest requests current source state
message StateRequest {
  // Optional state namespace/key
  string key = 1;
}

// StateResponse returns current source state
message StateResponse {
  // State as key-value pairs
  map<string, string> state = 1;

  // Opaque resume token for resuming from this position
  string resume_token = 2;

  // Last updated timestamp
  int64 last_updated_unix = 3;
}

// SaveStateRequest saves source state for crash recovery
message SaveStateRequest {
  // State to save
  map<string, string> state = 1;

  // Optional namespace/key
  string key = 2;
}
